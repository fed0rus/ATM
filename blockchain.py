from eth_abi import encode_abi
import json
import sys
import time
import requests
from web3 import Web3, HTTPProvider
import utilities

global ethConfig
global server
ethConfig = utilities.net()
server = Web3(HTTPProvider(ethConfig["rpcUrl"]))

def checkContractValidity(flag):
    suspicionAddress = utilities.getContractAddress(flag)
    utilities.isAddress(suspicionAddress)
    trueBinary = "608060405260043610610110576000357c010000000000000000000000000000000000000000000000000000000090048063942ea466116100a7578063b93f9b0a11610076578063b93f9b0a1461031a578063bd47824314610344578063f82c50f114610374578063fddc5f281461039e57610110565b8063942ea4661461026c578063987fa1ed1461029f5780639ee1bd0f146102d2578063a6f9dae1146102e757610110565b80635a58cd4c116100e35780635a58cd4c146101fa57806374adad1d1461020f57806383904f8d14610242578063851b16f51461025757610110565b806309e6707d146101125780631d25899b1461015757806330ccebb51461019d5780634ca1fad8146101d0575b005b34801561011e57600080fd5b506101456004803603602081101561013557600080fd5b5035600160a060020a03166104f4565b60408051918252519081900360200190f35b34801561016357600080fd5b506101816004803603602081101561017a57600080fd5b5035610506565b60408051600160a060020a039092168252519081900360200190f35b3480156101a957600080fd5b50610145600480360360208110156101c057600080fd5b5035600160a060020a0316610521565b3480156101dc57600080fd5b50610110600480360360208110156101f357600080fd5b5035610540565b34801561020657600080fd5b50610110610622565b34801561021b57600080fd5b506101456004803603602081101561023257600080fd5b5035600160a060020a0316610647565b34801561024e57600080fd5b50610110610659565b34801561026357600080fd5b50610110610717565b34801561027857600080fd5b506101456004803603602081101561028f57600080fd5b5035600160a060020a03166108dc565b3480156102ab57600080fd5b50610110600480360360208110156102c257600080fd5b5035600160a060020a031661091f565b3480156102de57600080fd5b50610181610c74565b3480156102f357600080fd5b506101106004803603602081101561030a57600080fd5b5035600160a060020a0316610c84565b34801561032657600080fd5b506101816004803603602081101561033d57600080fd5b5035610cd8565b34801561035057600080fd5b506101106004803603604081101561036757600080fd5b5080359060200135610d1a565b34801561038057600080fd5b506101816004803603602081101561039757600080fd5b5035610e14565b3480156103aa57600080fd5b506103d1600480360360208110156103c157600080fd5b5035600160a060020a0316610e3c565b6040518080602001806020018060200180602001858103855289818151815260200191508051906020019060200280838360005b8381101561041d578181015183820152602001610405565b50505050905001858103845288818151815260200191508051906020019060200280838360005b8381101561045c578181015183820152602001610444565b50505050905001858103835287818151815260200191508051906020019060200280838360005b8381101561049b578181015183820152602001610483565b50505050905001858103825286818151815260200191508051906020019060200280838360005b838110156104da5781810151838201526020016104c2565b505050509050019850505050505050505060405180910390f35b60016020526000908152604090205481565b600260205260009081526040902054600160a060020a031681565b600160a060020a0381166000908152600460205260409020545b919050565b33151561054c57600080fd5b6402540be4008110158015610566575064174876e7ff8111155b151561057157600080fd5b336000908152600460205260409020541561058b57600080fd5b33600090815260016020526040902054156105a557600080fd5b33600081815260046020526040808220849055517fdc79fc57451962cfe3916e686997a49229af75ce2055deb4c0f0fdf3d5d2e7c19190a250600380546001810182556000919091527fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b018054600160a060020a03191633179055565b600054600160a060020a0316331461063957600080fd5b600054600160a060020a0316ff5b60046020526000908152604090205481565b33151561066557600080fd5b336000908152600460205260409020541561067f57600080fd5b33600090815260016020526040902054151561069a57600080fd5b3360008181526004602052604080822060019055517f64ed2364f9ee0643b60aeffba4ace8805648fad0d546c5efd449d1de10c8dcee9190a2600380546001810182556000919091527fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b018054600160a060020a03191633179055565b33151561072357600080fd5b33600090815260046020526040902054151561073e57600080fd5b336000908152600460205260408120546001141561075a575060015b3360009081526004602052604081205580156107a05760405133907f8c08d387d1333f3da7e980dd7fc958615d513ca73155b6dd2a5a13e17acd116290600090a26107cc565b60405133907fffdf549003cf56ac2e863a28d8d5191467cf2a6d5e659f6a649e855a3d8cd8d090600090a25b60035460606000805b838110156108c15760038054339190839081106107ee57fe5b600091825260209091200154600160a060020a0316141561081257600191506108b9565b81151561086957600380548290811061082757fe5b6000918252602090912001548351600160a060020a039091169084908390811061084d57fe5b600160a060020a039092166020928302909101909101526108b9565b600380548290811061087757fe5b6000918252602090912001548351600160a060020a0390911690849060001984019081106108a157fe5b600160a060020a039092166020928302909101909101525b6001016107d5565b5081516108d5906003906020850190610efe565b5050505050565b600160a060020a03811660009081526001602052604081205415156109035750600061053b565b50600160a060020a031660009081526001602052604090205490565b600054600160a060020a0316331461093657600080fd5b600160a060020a0381166000908152600460205260409020546001811415610ae157600160a060020a0382166000818152600160209081526040808320805490849055808452600283528184208054600160a060020a03191690558484526004909252808320839055519092917f6381abe854c1429e636a1aa796dd6057d1f1e4836874fbb184650908c49804cc91a260035460606000805b83811015610ac35786600160a060020a03166003828154811015156109f057fe5b600091825260209091200154600160a060020a03161415610a145760019150610abb565b811515610a6b576003805482908110610a2957fe5b6000918252602090912001548351600160a060020a0390911690849083908110610a4f57fe5b600160a060020a03909216602092830290910190910152610abb565b6003805482908110610a7957fe5b6000918252602090912001548351600160a060020a039091169084906000198401908110610aa357fe5b600160a060020a039092166020928302909101909101525b6001016109cf565b508151610ad7906003906020850190610efe565b5050505050610c70565b6001811115610c7057600160a060020a03821660008181526004602081815260408084208054600184528286208190558552600283528185208054600160a060020a031916871790558585529290915290829055517fa010ae0edd95ff06bc66e3eacf9d4f39b23da7ae3056a38dd6c1dcd05630a6da9190a260035460606000805b83811015610c575785600160a060020a0316600382815481101515610b8457fe5b600091825260209091200154600160a060020a03161415610ba85760019150610c4f565b811515610bff576003805482908110610bbd57fe5b6000918252602090912001548351600160a060020a0390911690849083908110610be357fe5b600160a060020a03909216602092830290910190910152610c4f565b6003805482908110610c0d57fe5b6000918252602090912001548351600160a060020a039091169084906000198401908110610c3757fe5b600160a060020a039092166020928302909101909101525b600101610b63565b508151610c6b906003906020850190610efe565b505050505b5050565b600054600160a060020a03165b90565b600054600160a060020a03163314610c9b57600080fd5b600054600160a060020a0382811691161415610cb657600080fd5b60008054600160a060020a031916600160a060020a0392909216919091179055565b600081815260026020526040812054600160a060020a03161515610cfe5750600061053b565b50600090815260026020526040902054600160a060020a031690565b331515610d2657600080fd5b610d2e610f63565b338152602081019283526040810191825242606082019081526005805460018101825560009190915291517f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db060049093029283018054600160a060020a031916600160a060020a0390921691909117905592517f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db182015590517f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db282015590517f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db390910155565b6003805482908110610e2257fe5b600091825260209091200154600160a060020a0316905081565b600554606090819081908190819081908190819060005b81811015610eed578a600160a060020a0316600582815481101515610e7457fe5b6000918252602090912060049091020154600160a060020a03161415610e9d5785516001908790fe5b600160a060020a038b166000908152600160205260409020546005805483908110610ec457fe5b9060005260206000209060040201600101541415610ee55785516000908790fe5b600101610e53565b509399929850909650945092505050565b828054828255906000526020600020908101928215610f53579160200282015b82811115610f535782518254600160a060020a031916600160a060020a03909116178255602090920191600190910190610f1e565b50610f5f929150610f95565b5090565b6080604051908101604052806000600160a060020a031681526020016000815260200160008152602001600081525090565b610c8191905b80821115610f5f578054600160a060020a0319168155600101610f9b56fea165627a7a72305820da0704caf3c3f1b80fb56471e9a64844ad98a3f5674fbd3d2674dd9053341d960029"
    if server.eth.getCode(suspicionAddress).hex()[2:] != trueBinary:
        print("Seems that the contract address is not the registrar contract")
        sys.exit(1)

def getAdmin():
    return server.eth.account.privateKeyToAccount(ethConfig["privKey"])

def whoIsAdmin(flag):
    return call(flag, "whoIsOwner")

def getUser(PIN):
    utilities.checkPIN(PIN)
    PIN = [int(k) for k in PIN]
    id = utilities.userId()
    a = Web3.solidityKeccak(["bytes16"], [b''])
    b = Web3.solidityKeccak(["bytes16", "bytes16", "int8"], [a, id, PIN[0]])
    c = Web3.solidityKeccak(["bytes16", "bytes16", "int8"], [b, id, PIN[1]])
    d = Web3.solidityKeccak(["bytes16", "bytes16", "int8"], [c, id, PIN[2]])
    pk = Web3.solidityKeccak(["bytes16", "bytes16", "int8"], [d, id, PIN[3]])
    return server.eth.account.privateKeyToAccount(pk)

def gasPrice():
    try:
        response = requests.get(ethConfig["gasPriceUrl"])
        return int((response.json())["fast"] * 1e9)
    except requests.exceptions.RequestException:
        return int(ethConfig["defaultGasPrice"])

def cleanTx(rawReceipt):
    HexBytes = lambda x: x
    AttributeDict = lambda x: x
    return eval(str(rawReceipt)) if rawReceipt is not None else None

def getReceipt(txHash):
    while True:
        txReceipt = server.eth.getTransactionReceipt(txHash)
        if txReceipt is not None:
            return cleanTx(txReceipt)
        time.sleep(0.5)

def deploy(flag):
    admin = getAdmin()
    utilities.isAddress(admin.address)
    contractData = utilities.binContract(flag)
    rawContract = server.eth.contract(abi=contractData["abi"], bytecode=contractData["bin"])
    gas = rawContract.constructor().estimateGas({"from": admin.address})
    txUnsigned = rawContract.constructor().buildTransaction({
        "from": admin.address,
        "nonce": server.eth.getTransactionCount(admin.address),
        "gas": gas,
        "gasPrice": gasPrice(),
    })
    txSigned = admin.signTransaction(txUnsigned)
    try:
        deploymentHash = server.eth.sendRawTransaction(txSigned.rawTransaction)
    except ValueError:
        print("Insufficent funds for deployment")
        sys.exit(1)
    txReceipt = getReceipt(deploymentHash)
    if txReceipt["status"] == 1:
        contractAddress = txReceipt["contractAddress"]
        contract = server.eth.contract(
            address=contractAddress,
            abi=contractData["abi"],
        )
        startBlock = txReceipt["blockNumber"]
        data = {
            "address": contract.address,
            "startBlock": startBlock
        }
        return data
    else:
        print("Deployment failed")
        sys.exit(1)

def allDeploy():
    kycData = deploy("kyc")
    phData = deploy("ph")
    with open("registrar.json", 'w') as file:
        data = {
            "registrar": kycData,
            "payments": phData
        }
        json.dump(data, file)

def getContract(flag):
    checkContractValidity(flag)
    contractAbi = utilities.binContract(flag)["abi"]
    contractAddress = utilities.getContractAddress(flag)
    contract = server.eth.contract(address=contractAddress, abi=contractAbi)
    return contract

def isSufficient(user, gas, value=0):
    utilities.isAddress(user.address)
    balance = server.eth.getBalance(user.address)
    return balance >= value + gas * gasPrice()

def call(flag, methodName, methodArgs=[]):
    checkContractValidity(flag)
    contract = getContract(flag)
    args = str(methodArgs)[1:-1]
    rawCall = "contract.functions.{methodName}({methodArgs}).call()".format(methodName=methodName, methodArgs=args)
    return eval(rawCall)

def invoke(flag, sender, methodName, methodArgs, chown=False, add=False):
    checkContractValidity(flag)
    utilities.isAddress(sender.address)
    contract = getContract(flag)
    args = str(methodArgs)[1:-1]
    invoker = "contract.functions.{methodName}({methodArgs})".format(methodName=methodName, methodArgs=args)
    try:
        gas = eval(invoker).estimateGas({"from": sender.address})
    except:
        if chown:
            print("Request cannot be executed")
            sys.exit(1)
    if add:
        if not isSufficient(sender, gas):
            print("No funds to send the request")
            sys.exit(1)
    # add other exceptions for flags
    txUnsigned = eval(invoker).buildTransaction({
        "from": sender.address,
        "nonce": server.eth.getTransactionCount(sender.address),
        "gas": gas,
        "gasPrice": gasPrice(),
    })
    txSigned = sender.signTransaction(txUnsigned)
    try:
        txHash = server.eth.sendRawTransaction(txSigned.rawTransaction)
    except:
        print("Kahoot")
        sys.exit(1)
    txReceipt = getReceipt(txHash)
    tx = {
        "status": txReceipt["status"],
        "txHash": txReceipt["transactionHash"]
    }
    return tx

def chown(newOwner):
    checkContractValidity("kyc")
    utilities.isAddress(newOwner)
    admin = getAdmin()
    utilities.isAddress(admin.address)
    tx = invoke("kyc", admin, methodName="changeOwner", methodArgs=[newOwner], chown=True)
    if tx["status"] != 1:
        print("Transfering ownership failed, but included in {}".format(tx["txHash"]))
        sys.exit(1)

def getBalance(PIN):
    user = getUser(PIN)
    utilities.isAddress(user.address)
    return utilities.normalizeValue(server.eth.getBalance(user.address))

def addRequest(PIN, phoneNumber):
    checkContractValidity("kyc")
    utilities.checkPIN(PIN)
    user = getUser(PIN)
    utilities.isAddress(user.address)
    phoneNumber = utilities.checkAndRefinePhoneNumber(phoneNumber)
    requestStatus = call("kyc", "getStatus", [user.address])
    if requestStatus == 0:
        tx = invoke("kyc", user, "addRequest", [phoneNumber], add=True)
        if tx["status"] == 1:
            return tx["txHash"]
        else:
            print("Failed, but included in {}".format(tx["txHash"]))
            sys.exit(1)
    elif requestStatus == 1:
        print("You have already sent a request for unregistration. Cancel it, and then try again")
        sys.exit(1)
    elif requestStatus > 1:
        print("Registration request already sent")
        sys.exit(1)
    else:
        print("Invalid status")
        sys.exit(1)
